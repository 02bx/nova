{% extends 'base.html' %}
{% block title %}Console{% endblock %}

{% block content %}
    <div class="container col-sm-8 col-md-12" xmlns="http://www.w3.org/1999/html">
        <div class="col-md-offset-1 console-instance-head clearfix">
            <div class="pull-left">
                <h3>
                    <span>任务名称—</span>
                    <span>{{ task_name }}</span>
                </h3>
            </div>
        </div>
        <div class="col-md-offset-1 margin-top-1">
            <span>Started by user {{ task_exec_user }}</span></p>
            <span>控制台输出：</span>
        </div>
        <div class="col-md-offset-1 margin-top-1" id=toolbar>
            <span id="id_log_file" style="display: none">{{ file_path }}</span>
            <span id="id_file_size" style="display: none">{{ file_size }}</span>
            <pre style="width: 100%;" id='log'>{% for line in task_logs %}{{ line }}{% endfor %}</pre>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script>
        var seek = Number($("#id_file_size").text());
        var log_file = $("#id_log_file").text();
        console.log(seek);
        function errmsg() {
            alert("请联系管理员！");
        }
        $(function () {
            var t = setInterval(function () {
                $.ajax({
                    url: "{% url 'get_new_line' %}",
                    type: 'POST',
                    data: JSON.stringify({
                        file: log_file,
                        seek: seek
                    }),
                    success: function (data) {
                        seek = data['seek'];
                        var list = data['lines'];
                        if (list.length != 0) {
                            var div = document.getElementById('log');
                            for (var i = 0; i < list.length; i++) {
                                var line = list[i];
                                $("#log").append(line);
                                div.scrollTop = div.scrollHeight;
                            }
                        }
                    },
                    error: function (data) {
                        errmsg();
                        clearInterval(t);
                        return false;
                    },
                    dataType: "json",
                    contentType: "application/json"
                });
            }, 10000);
        });
    </script>
{% endblock %}